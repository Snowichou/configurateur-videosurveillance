<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Configurateur</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background:#0b0f14; color:#e8eef6; }
    .card { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; max-width:1100px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, button, textarea { border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:#e8eef6; padding:10px 12px; }
    button { cursor:pointer; }
    textarea { width:100%; min-height: 520px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; line-height: 1.4; }
    .muted { color: rgba(232,238,246,.7); font-size: 13px; }
    .tabs button { padding:10px 12px; }
    .ok { color:#7CFC98; font-weight:700; }
    .err { color:#ff6b6b; font-weight:700; }
    .hint { font-size:12px; color: rgba(232,238,246,.55); margin-top:6px; }
  </style>
</head>
<body>
  <h1>Admin panel</h1>

  <div class="card">
    <div class="row">
      <input id="pwd" type="password" placeholder="Mot de passe admin" style="min-width:260px" />
      <button id="btnLogin">Se connecter</button>
      <button id="btnLogout" title="Supprime le token">Se déconnecter</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="hint">
      ℹ️ Lecture/écriture CSV via API. Si tu vois 401 → reconnecte-toi (token expiré ou manquant).
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0;">

    <div class="row tabs">
      <button data-csv="cameras">cameras.csv</button>
      <button data-csv="nvrs">nvrs.csv</button>
      <button data-csv="hdds">hdds.csv</button>
      <button data-csv="switches">switches.csv</button>
      <button data-csv="accessories">accessories.csv</button>
      <button data-csv="screens">screens.csv</button>
      <button data-csv="enclosures">enclosures.csv</button>
      <button data-csv="signage">signage.csv</button>
      <span class="muted" id="activeTab"></span>
    </div>

    <div style="margin-top:12px" class="muted">
      ✅ Tu édites le CSV brut. Sauvegarde = écrit sur disque + backup .bak automatique.
    </div>

    <div style="margin-top:12px">
      <textarea id="editor" placeholder="Charge un CSV..."></textarea>
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <button id="btnReload">Recharger</button>
      <button id="btnSave">Sauvegarder</button>
    </div>
  </div>

<script>
(() => {
  let token = localStorage.getItem("admin_token") || "";
  let active = "cameras";

  const $ = (s) => document.querySelector(s);

  function setStatus(msg, kind = "muted") {
    const el = $("#status");
    el.className = kind;
    el.textContent = msg || "";
  }

  function clearToken() {
    token = "";
    localStorage.removeItem("admin_token");
  }

  function authHeaders() {
    return token ? { "Authorization": `Bearer ${token}` } : {};
  }

  async function readTextSafe(res) {
    try { return await res.text(); } catch { return ""; }
  }

  async function login() {
    const password = $("#pwd").value.trim();
    if (!password) {
      setStatus("Entre le mot de passe.", "err");
      return;
    }

    setStatus("Connexion...");
    try {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ password }),
        credentials: "same-origin",
      });

      const txt = await readTextSafe(res);
      if (!res.ok) {
        clearToken();
        throw new Error(`Login refusé (${res.status}) ${txt || ""}`.trim());
      }

      let data = null;
      try { data = JSON.parse(txt); } catch {}

      token = data?.token || "";
      if (!token) {
        clearToken();
        throw new Error("Login OK mais token manquant (réponse invalide).");
      }

      localStorage.setItem("admin_token", token);
      $("#pwd").value = "";
      setStatus("Connecté ✅", "ok");
      await loadActive();
    } catch (e) {
      setStatus(e?.message || "Erreur login", "err");
    }
  }

  async function logout() {
    clearToken();
    $("#editor").value = "";
    setStatus("Déconnecté.", "muted");
  }

  async function loadCsv(name) {
    setStatus(`Chargement ${name}...`);

    const res = await fetch(`/api/csv/${name}`, {
      cache: "no-store",
      headers: { ...authHeaders() },
      credentials: "same-origin",
    });

    const txt = await readTextSafe(res);

    if (res.status === 401) {
      clearToken();
      $("#editor").value = "";
      setStatus(`401 Unauthorized → reconnecte-toi. ${txt || ""}`.trim(), "err");
      return;
    }

    if (!res.ok) {
      $("#editor").value = "";
      setStatus(`Erreur chargement (${res.status}) ${txt || ""}`.trim(), "err");
      return;
    }

    $("#editor").value = txt;
    setStatus("Chargé ✅", "ok");
  }

  async function saveCsv(name) {
    if (!token) {
      setStatus("Non connecté. Clique 'Se connecter'.", "err");
      return;
    }

    setStatus("Sauvegarde...");
    const content = $("#editor").value;

    const res = await fetch(`/api/csv/${name}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...authHeaders(),
      },
      credentials: "same-origin",
      body: JSON.stringify({ content }),
    });

    const txt = await readTextSafe(res);

    if (res.status === 401) {
      clearToken();
      setStatus(`401 Unauthorized → reconnecte-toi. ${txt || ""}`.trim(), "err");
      return;
    }

    if (!res.ok) {
      setStatus(`Sauvegarde refusée (${res.status}) ${txt || ""}`.trim(), "err");
      return;
    }

    setStatus("Sauvegardé ✅ (backup .bak fait)", "ok");
  }

  async function loadActive() {
    $("#activeTab").textContent = "• " + active;
    await loadCsv(active);
  }

  document.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-csv]");
    if (!b) return;
    active = b.getAttribute("data-csv");
    await loadActive();
  });

  $("#btnLogin").addEventListener("click", login);
  $("#btnLogout").addEventListener("click", logout);
  $("#btnReload").addEventListener("click", loadActive);
  $("#btnSave").addEventListener("click", () => saveCsv(active));

  $("#pwd").addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });

  if (token) {
    setStatus("Token trouvé (session) ✅", "ok");
    loadActive().catch(() => {
      clearToken();
      setStatus("Token invalide/expiré, reconnecte-toi.", "err");
    });
  } else {
    setStatus("Connecte-toi pour éditer.", "muted");
  }
})();
</script>
</body>
</html>
