<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Configurateur</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background:#0b0f14; color:#e8eef6; }
    .card { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; max-width:1100px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, button, select, textarea { border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:#e8eef6; padding:10px 12px; }
    button { cursor:pointer; }
    textarea { width:100%; min-height: 520px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; line-height: 1.4; }
    .muted { color: rgba(232,238,246,.7); font-size: 13px; }
    .tabs button { padding:10px 12px; }
    .ok { color:#7CFC98; font-weight:700; }
    .err { color:#ff6b6b; font-weight:700; }
  </style>
</head>
<body>
  <h1>Admin panel</h1>
  <div class="card">
    <div class="row">
      <input id="pwd" type="password" placeholder="Mot de passe admin" style="min-width:260px" />
      <button id="btnLogin">Se connecter</button>
      <span id="status" class="muted"></span>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:14px 0;">

    <div class="row tabs">
      <button data-csv="cameras">cameras.csv</button>
      <button data-csv="nvrs">nvrs.csv</button>
      <button data-csv="hdds">hdds.csv</button>
      <button data-csv="switches">switches.csv</button>
      <button data-csv="accessories">accessories.csv</button>
      <span class="muted" id="activeTab"></span>
    </div>

    <div style="margin-top:12px" class="muted">
      ✅ Tu édites le CSV brut. Sauvegarde = écrit sur disque + backup .bak automatique.
    </div>

    <div style="margin-top:12px">
      <textarea id="editor" placeholder="Charge un CSV..."></textarea>
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <button id="btnReload">Recharger</button>
      <button id="btnSave">Sauvegarder</button>
    </div>
  </div>

<script>
(() => {
  let token = localStorage.getItem("admin_token") || "";
  let active = "cameras";

  const $ = (s) => document.querySelector(s);
  const status = (msg, kind="muted") => {
    const el = $("#status");
    el.className = kind;
    el.textContent = msg || "";
  };

  async function login() {
    const password = $("#pwd").value.trim();
    status("Connexion...");
    try {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ password })
      });
      if (!res.ok) throw new Error("Mot de passe invalide");
      const data = await res.json();
      token = data.token;
      localStorage.setItem("admin_token", token);
      status("Connecté ✅", "ok");
      await loadActive();
    } catch (e) {
      status(e.message, "err");
    }
  }

  async function loadCsv(name) {
    status("Chargement...");
    const res = await fetch(`/api/csv/${name}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`Impossible de charger ${name}`);
    const txt = await res.text();
    $("#editor").value = txt;
    status("Chargé ✅", "ok");
  }

  async function saveCsv(name) {
    if (!token) throw new Error("Non connecté");
    status("Sauvegarde...");
    const content = $("#editor").value;
    const res = await fetch(`/api/csv/${name}`, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ content })
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`Sauvegarde refusée (${res.status}) ${t}`);
    }
    status("Sauvegardé ✅ (backup .bak fait)", "ok");
  }

  async function loadActive() {
    $("#activeTab").textContent = "• " + active;
    await loadCsv(active);
  }

  // tabs
  document.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-csv]");
    if (!b) return;
    active = b.getAttribute("data-csv");
    await loadActive();
  });

  $("#btnLogin").addEventListener("click", login);
  $("#btnReload").addEventListener("click", loadActive);
  $("#btnSave").addEventListener("click", () => saveCsv(active).catch(err => status(err.message, "err")));

  // auto-load si token existe
  if (token) {
    status("Token trouvé (session) ✅", "ok");
    loadActive().catch(() => status("Token expiré, reconnecte-toi.", "err"));
  } else {
    status("Connecte-toi pour éditer.", "muted");
  }
})();
</script>
</body>
</html>
