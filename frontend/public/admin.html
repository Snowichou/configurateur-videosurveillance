<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Configurateur Comelit</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root{
      --cosmos:#1C1F2B;
      --green:#00BC70;
      --bg:#F6F7F9;
      --card:#ffffff;
      --line: rgba(28,31,42,.14);
      --muted: rgba(15,23,42,.62);
      --shadow: 0 10px 22px rgba(2,6,23,.06);
      --r: 16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    body{margin:0;background:var(--bg);color:var(--cosmos);}
    
    /* ============================================================
       LOGIN OVERLAY - BLOQUE TOUT
       ============================================================ */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1C1F2B 0%, #2d3348 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #loginOverlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .loginBox {
      background: #fff;
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.3);
      text-align: center;
    }
    .loginLogo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      border-radius: 20px;
      border: 2px solid var(--line);
      background: #fff;
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .loginLogo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .loginTitle {
      font-size: 24px;
      font-weight: 950;
      color: var(--cosmos);
      margin-bottom: 8px;
    }
    .loginSubtitle {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 30px;
    }
    .loginInput {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--line);
      border-radius: 14px;
      font-size: 16px;
      margin-bottom: 16px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }
    .loginInput:focus {
      outline: none;
      border-color: var(--green);
    }
    .loginBtn {
      width: 100%;
      padding: 14px 24px;
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .loginBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,188,112,0.3);
    }
    .loginBtn:active {
      transform: translateY(0);
    }
    .loginBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .loginError {
      color: #DC2626;
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }
    .loginFooter {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
    }
    .securityBadge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(0,188,112,0.1);
      border: 1px solid rgba(0,188,112,0.2);
      border-radius: 20px;
      font-size: 11px;
      color: #065f46;
    }
    
    /* ============================================================
       ADMIN CONTENT (cache par defaut)
       ============================================================ */
    #adminContent {
      display: none;
    }
    #adminContent.visible {
      display: block;
    }
    
    header{
      position:sticky;top:0;z-index:5;
      background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{
      width: min(1400px, calc(100vw - 32px));
      margin: 0 auto;
      padding: 16px;
      max-width: 100%;
      overflow-x: hidden;
    }
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      border:1px solid var(--line);background:#fff;
      display:grid;place-items:center;overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:contain;}
    .title{font-weight:950;line-height:1.1}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .tabs{display:flex;gap:8px;margin-top:12px;}
    .tabBtn{
      border:1px solid var(--line);background:#fff;color:var(--cosmos);
      padding:8px 14px;border-radius:999px;font-weight:900;font-size:13px;
      cursor:pointer;transition:all .15s ease;
    }
    .tabBtn:hover{border-color:rgba(0,188,112,.35)}
    .tabBtn.on{border-color:rgba(0,188,112,.45);background:rgba(0,188,112,.10);}
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 14px;
      margin-top: 14px;
      width: 100%;
      max-width: 100%;
    }
    .gridFull{
      grid-template-columns: 1fr;
    }
    @media(max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      box-shadow:var(--shadow); padding:14px;
    }
    .h{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .h .h1{font-weight:950}
    .h .h2{color:var(--muted);font-size:12.5px;margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;font-weight:900;font-size:12.5px;}
    .pill.ok{border-color:rgba(0,188,112,.35);background:rgba(0,188,112,.10)}
    .pill.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#92400e}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{font:inherit}
    .in{
      border:1px solid var(--line);border-radius:12px;background:#fff;
      padding:10px 12px; min-height:40px;
    }
    .btn{
      border:1px solid var(--line);border-radius:12px;background:#fff;color:var(--cosmos);
      padding:10px 12px; min-height:40px; font-weight:900;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:hover{border-color:rgba(0,188,112,.35);box-shadow:0 10px 22px rgba(2,6,23,.08);transform:translateY(-1px);}
    .btn.primary{border-color:rgba(0,188,112,.45);background:rgba(0,188,112,.12)}
    .btn.danger{border-color:rgba(220,38,38,.35);background:rgba(220,38,38,.08)}
    .muted{color:var(--muted);font-size:12.5px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none!important}

    /* Table editor */
    .tableWrap{
      width: 100%;
      max-width: 100%;
      min-width: 0;
      overflow: auto;
      border:1px solid var(--line);
      border-radius:14px;
      max-height: calc(100vh - 260px);
    }
    .tableWrap table{
      border-collapse: collapse;
      background:#fff;
      width: max-content;
      min-width: 100%;
      table-layout: fixed;
    }
    .tableWrap th,
    .tableWrap td{
      border-bottom:1px solid rgba(28,31,42,.10);
      padding:10px 10px;
      vertical-align:top;
      white-space: nowrap;
    }
    .tableWrap th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      font-size: 12px;
      text-align: left;
      font-weight: 950;
    }
    .tableWrap td input{
      width: 140px;
      max-width: 100%;
      box-sizing: border-box;
      border:1px solid rgba(28,31,42,.12);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      min-height:36px;
    }
    .actionsCol{white-space:nowrap}
    .miniBtn{
      padding:7px 10px;min-height:34px;border-radius:10px;font-weight:900;font-size:12px;
      border:1px solid var(--line);background:#fff;cursor:pointer;
    }
    .miniBtn:hover{border-color:rgba(0,188,112,.35)}
    .miniBtn.del{border-color:rgba(220,38,38,.30);background:rgba(220,38,38,.06)}

    /* KPI Tiles */
    .kpiGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media(max-width:900px){ .kpiGrid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:500px){ .kpiGrid{grid-template-columns:1fr} }
    .grid{display:grid;gap:10px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr !important} }
    .kpiTile{
      border:1px solid var(--line);border-radius:14px;background:#fff;padding:14px;
      transition:all .15s ease;
    }
    .kpiTile:hover{border-color:rgba(0,188,112,.3);box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .kpiLabel{color:var(--muted);font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.3px}
    .kpiVal{font-weight:950;font-size:28px;margin-top:6px;color:var(--cosmos)}
    .kpiVal small{font-size:14px;font-weight:800;color:var(--muted)}
    .kpiTrend{font-size:12px;margin-top:4px}
    .kpiTrend.up{color:#00BC70}
    .kpiTrend.down{color:#DC2626}

    /* Charts */
    .chartWrap{
      width:100%;height:280px;
      border:1px solid var(--line);border-radius:14px;
      background:#fff;padding:14px;box-sizing:border-box;
    }
    .chartTitle{font-weight:950;font-size:14px;margin-bottom:10px}

    /* Top lists */
    .list{margin:0;padding:0;list-style:none}
    .list li{
      display:flex;justify-content:space-between;gap:10px;
      padding:10px 0;border-bottom:1px solid rgba(28,31,42,.08)
    }
    .list li:last-child{border-bottom:0}
    .list .rank{
      width:24px;height:24px;border-radius:8px;
      background:rgba(0,188,112,.1);color:#00BC70;
      font-weight:900;font-size:11px;
      display:grid;place-items:center;flex-shrink:0;
    }
    .list .rank.top3{background:rgba(0,188,112,.2)}
    .list .name{flex:1;font-weight:800;font-size:13px}
    .list .val{font-weight:900;font-size:13px;color:var(--cosmos)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}

    /* Month selector */
    .monthSelector{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:12px;
      padding:4px;background:#fff;
    }
    .monthSelector button{
      border:none;background:transparent;padding:8px 12px;
      border-radius:10px;font-weight:900;font-size:13px;cursor:pointer;
    }
    .monthSelector button:hover{background:rgba(0,188,112,.08)}
    .monthSelector span{font-weight:900;min-width:140px;text-align:center}

    /* ============================================================
       RESPONSIVE
       ============================================================ */
    @media(max-width:768px){
      .topBar{flex-direction:column;gap:10px;padding:12px}
      .topBar .row{flex-wrap:wrap;gap:6px}
      .tabs{flex-wrap:wrap}
      main{padding:10px}
      .card{padding:12px}
      .row{flex-wrap:wrap;gap:6px}
      .monthSelector{width:100%;justify-content:center}
      .monthSelector span{min-width:100px;font-size:13px}
      .kpiVal{font-size:22px}
      .tableWrap{max-height:60vh}
      .tableWrap td input{width:100px;padding:6px 8px;font-size:12px}
      .list .name{font-size:12px}
      .list .val{font-size:12px}
      .h1{font-size:14px}
      .h2{font-size:11px}
    }
    @media(max-width:500px){
      .topBar{padding:10px}
      main{padding:6px}
      .card{padding:10px;border-radius:12px}
      .btn,.tabBtn{padding:8px 12px;font-size:11px}
      .kpiVal{font-size:18px}
      .loginBox{padding:24px 20px;margin:10px}
    }
  </style>
  <!-- Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- ============================================================
     LOGIN OVERLAY - BLOQUE TOUT LE CONTENU
     ============================================================ -->
<div id="loginOverlay">
  <div class="loginBox">
    <div class="loginLogo">
      <img src="/assets/logo.png" onerror="this.parentElement.innerHTML='ðŸ”'" alt="COMELIT">
    </div>
    <div class="loginTitle">Administration</div>
    <div class="loginSubtitle">Configurateur Videosurveillance Comelit</div>
    
    <form id="loginForm">
      <input 
        type="password" 
        id="loginPassword" 
        class="loginInput" 
        placeholder="Mot de passe administrateur"
        autocomplete="current-password"
        required
      >
      <button type="submit" id="loginBtn" class="loginBtn">
        Se connecter
      </button>
    </form>
    
    <div id="loginError" class="loginError"></div>
    
    <div class="loginFooter">
      <div class="securityBadge">
        ðŸ”’ Connexion securisee
      </div>
    </div>
  </div>
</div>

<!-- ============================================================
     CONTENU ADMIN (CACHE PAR DEFAUT)
     ============================================================ -->
<div id="adminContent">
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo"><img src="/assets/logo.png" onerror="this.style.display='none'" alt="COMELIT"></div>
          <div>
            <div class="title">Admin Configurateur</div>
            <div class="sub">Catalogues + KPI Metier</div>
          </div>
        </div>
        <div class="row">
          <span id="authState" class="pill ok">Connecte</span>
          <button class="btn" id="btnLogout">Deconnexion</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn on" data-tab="catalog">Catalogues</button>
        <button class="tabBtn" data-tab="kpi">KPI Metier</button>
        <button class="tabBtn" data-tab="health">Sante BDD</button>
        <button class="tabBtn" data-tab="events">Evenements bruts</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- CATALOG -->
    <section id="tab_catalog">
      <div class="grid">
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Editeur de catalogues</div>
              <div class="h2">Modification des donnees produits</div>
            </div>
            <div class="row">
              <select id="catalogKind" class="in">
                <option value="cameras">cameras</option>
                <option value="nvrs">nvrs</option>
                <option value="hdds">hdds</option>
                <option value="switches">switches</option>
                <option value="accessories">accessories</option>
                <option value="screens">screens</option>
                <option value="enclosures">enclosures</option>
                <option value="signage">signage</option>
              </select>
              <button id="btnLoad" class="btn">Charger</button>
              <button id="btnAddRow" class="btn">+ Ligne</button>
              <button id="btnSave" class="btn primary">Enregistrer</button>
            </div>
          </div>

          <div id="catMeta" class="muted"></div>
          <div class="sep"></div>

          <div class="tableWrap">
            <table id="catTable">
              <thead><tr id="catHead"></tr></thead>
              <tbody id="catBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Guide</div>
              <div class="h2">Conseils d'utilisation</div>
            </div>
          </div>
          <ul class="list">
            <li><span>Cameras</span><span class="pill">Principal</span></li>
            <li><span>NVRs</span><span class="pill">Enregistreurs</span></li>
            <li><span>HDDs</span><span class="pill">Stockage</span></li>
            <li><span>Switches</span><span class="pill">Reseau</span></li>
            <li><span>Accessories</span><span class="pill">Supports</span></li>
          </ul>
          <div class="sep"></div>
          <div class="muted">
            Modifiez les donnees puis cliquez sur "Enregistrer". Les modifications sont immediates.
          </div>
        </div>
      </div>
    </section>

    <!-- KPI METIER -->
    <section id="tab_kpi" class="hidden">
      <!-- Selecteur de mois -->
      <div class="row" style="margin-bottom:14px;justify-content:space-between">
        <div class="monthSelector">
          <button id="btnPrevMonth">&larr;</button>
          <span id="currentMonth">Janvier 2025</span>
          <button id="btnNextMonth">&rarr;</button>
        </div>
        <div class="row">
          <button id="btnRefreshKpi" class="btn">Rafraichir</button>
          <button id="btnExportKpi" class="btn primary">Exporter CSV</button>
          <button id="btnResetMonth" class="btn danger">Reset mois (tests)</button>
        </div>
      </div>

      <!-- KPIs principaux â€” ligne 1 -->
      <div class="kpiGrid" style="margin-bottom:14px">
        <div class="kpiTile">
          <div class="kpiLabel">Configurations generees</div>
          <div id="kpiConfigs" class="kpiVal">--</div>
          <div id="kpiConfigsTrend" class="kpiTrend"></div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Cameras configurees</div>
          <div id="kpiCameras" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Camera moyenne/config</div>
          <div id="kpiAvgCam" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Sessions uniques</div>
          <div id="kpiSessions" class="kpiVal">--</div>
        </div>
      </div>

      <!-- KPIs secondaires â€” ligne 2 -->
      <div class="kpiGrid" style="margin-bottom:14px">
        <div class="kpiTile">
          <div class="kpiLabel">Stockage moyen</div>
          <div id="kpiAvgStorage" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Debit moyen</div>
          <div id="kpiAvgMbps" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Retention moyenne</div>
          <div id="kpiAvgRetention" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Taux complements</div>
          <div id="kpiComplementRate" class="kpiVal">--</div>
        </div>
      </div>

      <!-- Graphiques ligne 1 -->
      <div class="grid" style="grid-template-columns:1fr 1fr;margin-bottom:14px">
        <div class="card">
          <div class="chartTitle">Evolution des configurations (12 derniers mois)</div>
          <div style="height:250px">
            <canvas id="chartConfigs"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="chartTitle">Repartition par type de site</div>
          <div style="height:250px">
            <canvas id="chartSiteTypes"></canvas>
          </div>
        </div>
      </div>

      <!-- Top cameras / NVR / Gammes -->
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Top 10 Cameras</div>
              <div class="h2">References les plus configurees</div>
            </div>
          </div>
          <ul id="topCameras" class="list"></ul>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Top NVR</div>
              <div class="h2">Enregistreurs recommandes</div>
            </div>
          </div>
          <ul id="topNvrs" class="list"></ul>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Gammes produits</div>
              <div class="h2">Repartition des ventes</div>
            </div>
          </div>
          <ul id="topRanges" class="list"></ul>
        </div>
      </div>

      <!-- Graphiques ligne 2 : ActivitÃ© + DORI + Emplacements -->
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:14px">
        <div class="card">
          <div class="chartTitle">Activite par jour de la semaine</div>
          <div style="height:200px">
            <canvas id="chartWeekday"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="chartTitle">Objectifs DORI</div>
          <div style="height:200px">
            <canvas id="chartDori"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="chartTitle">Emplacements</div>
          <div style="height:200px">
            <canvas id="chartEmplacement"></canvas>
          </div>
        </div>
      </div>

      <!-- Ligne 3 : Distances + Codecs + ComplÃ©ments -->
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:14px">
        <div class="card">
          <div class="chartTitle">Distances configurees</div>
          <div style="height:200px">
            <canvas id="chartDistances"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Parametres enregistrement</div>
              <div class="h2">Codecs et FPS les plus utilises</div>
            </div>
          </div>
          <ul id="topRecording" class="list"></ul>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Complements</div>
              <div class="h2">Taux d'activation par type</div>
            </div>
          </div>
          <div id="complementStats" class="muted">--</div>
        </div>
      </div>

      <!-- Ligne 4 : Top HDD + Switches + Ã‰crans -->
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:14px">
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Top HDD</div>
              <div class="h2">Disques les plus recommandes</div>
            </div>
          </div>
          <ul id="topHdds" class="list"></ul>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Top distances</div>
              <div class="h2">Distances cibles les plus demandees</div>
            </div>
          </div>
          <ul id="topDistances" class="list"></ul>
        </div>
        <div class="card">
          <div class="h">
            <div>
              <div class="h1">Tailles ecrans</div>
              <div class="h2">Preferences utilisateurs</div>
            </div>
          </div>
          <ul id="topScreenSizes" class="list"></ul>
        </div>
      </div>
    </section>

    <!-- SANTE BDD -->
    <section id="tab_health" class="hidden">
      <div class="kpiGrid" style="margin-bottom:14px">
        <div class="kpiTile">
          <div class="kpiLabel">Total produits</div>
          <div id="healthTotal" class="kpiVal">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Sans image</div>
          <div id="healthNoImg" class="kpiVal" style="color:#DC2626">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Sans fiche technique</div>
          <div id="healthNoDs" class="kpiVal" style="color:#F59E0B">--</div>
        </div>
        <div class="kpiTile">
          <div class="kpiLabel">Completude</div>
          <div id="healthScore" class="kpiVal">--</div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:1fr">
        <div class="card">
          <div class="h" style="margin-bottom:12px">
            <div>
              <div class="h1">Etat des catalogues</div>
              <div class="h2">Couverture images et fiches techniques par famille</div>
            </div>
            <button id="btnRefreshHealth" class="btn">Analyser</button>
          </div>
          <div id="healthDetails" class="muted">Cliquez sur Analyser pour scanner les catalogues.</div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:1fr;margin-top:14px">
        <div class="card">
          <div class="h" style="margin-bottom:12px">
            <div>
              <div class="h1">Produits incomplets</div>
              <div class="h2">References avec donnees manquantes</div>
            </div>
          </div>
          <div id="healthMissing" class="muted">--</div>
        </div>
      </div>
    </section>

    <!-- EVENTS BRUTS -->
    <section id="tab_events" class="hidden">
      <div class="card">
        <div class="h">
          <div>
            <div class="h1">Evenements bruts</div>
            <div class="h2">Debug et analyse detaillee</div>
          </div>
          <div class="row">
            <select id="kpiLimit" class="in">
              <option value="50">50</option>
              <option value="200" selected>200</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
            </select>
            <select id="kpiEventType" class="in">
              <option value="">Tous les events</option>
              <option value="compute_project">compute_project</option>
              <option value="validate_camera">validate_camera</option>
              <option value="nav_next">nav_next</option>
              <option value="export_pdf">export_pdf</option>
            </select>
            <button id="btnLoadEvents" class="btn">Charger</button>
          </div>
        </div>
        <div class="sep"></div>
        <div id="kpiEvents" class="muted" style="max-height:500px;overflow:auto"></div>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const LS_TOKEN = "cfg_admin_token";
  let token = localStorage.getItem(LS_TOKEN) || "";
  let catalog = { kind:"", filename:"", columns:[], rows:[] };
  
  // Mois courant pour les KPIs
  let currentMonth = new Date();
  
  // Charts instances
  let chartConfigs = null;
  let chartSiteTypes = null;
  let chartWeekday = null;
  let chartDori = null;
  let chartEmplacement = null;
  let chartDistances = null;

  // ==================== AUTH ====================
  function showAdmin() {
    $("#loginOverlay").classList.add("hidden");
    $("#adminContent").classList.add("visible");
  }
  
  function hideAdmin() {
    $("#loginOverlay").classList.remove("hidden");
    $("#adminContent").classList.remove("visible");
  }
  
  function checkAuth() {
    if (token) {
      // Verifier que le token est encore valide avec un appel API
      api("/api/kpi/summary")
        .then(() => {
          showAdmin();
          initAdminContent();
        })
        .catch(() => {
          // Token invalide ou expire
          token = "";
          localStorage.removeItem(LS_TOKEN);
          hideAdmin();
        });
    } else {
      hideAdmin();
    }
  }

  async function api(path, opts={}){
    const headers = Object.assign({"Content-Type":"application/json"}, opts.headers||{});
    if(token) headers["Authorization"] = "Bearer " + token;
    const res = await fetch(path, Object.assign({}, opts, {headers}));
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(t || ("HTTP "+res.status));
    }
    const ct = res.headers.get("content-type") || "";
    if(ct.includes("application/json")) return await res.json();
    return await res.text();
  }

  // ==================== LOGIN FORM ====================
  $("#loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const btn = $("#loginBtn");
    const errorDiv = $("#loginError");
    const pwd = $("#loginPassword").value;
    
    errorDiv.textContent = "";
    btn.disabled = true;
    btn.textContent = "Connexion...";
    
    try {
      const out = await api("/api/login", {
        method: "POST", 
        body: JSON.stringify({password: pwd}),
        headers: {}
      });
      
      token = out.token;
      localStorage.setItem(LS_TOKEN, token);
      
      showAdmin();
      initAdminContent();
      
    } catch(e) {
      errorDiv.textContent = "Mot de passe incorrect";
      $("#loginPassword").value = "";
      $("#loginPassword").focus();
    } finally {
      btn.disabled = false;
      btn.textContent = "Se connecter";
    }
  });

  // ==================== LOGOUT ====================
  $("#btnLogout").addEventListener("click", () => {
    token = "";
    localStorage.removeItem(LS_TOKEN);
    hideAdmin();
    $("#loginPassword").value = "";
  });

  // ==================== INIT ADMIN CONTENT ====================
  function initAdminContent() {
    // Charger le premier catalogue
    $("#btnLoad").click();
    // Rafraichir les KPIs
    updateMonthDisplay();
    refreshKpiMetier();
  }

  // ==================== TABS ====================
  $$(".tabBtn").forEach(b => b.addEventListener("click", () => {
    $$(".tabBtn").forEach(x => x.classList.remove("on"));
    b.classList.add("on");
    const tab = b.dataset.tab;
    ["catalog","kpi","health","events"].forEach(t => {
      const el = $(`#tab_${t}`);
      if(el) el.classList.toggle("hidden", tab !== t);
    });
    if(tab === "kpi") refreshKpiMetier();
    if(tab === "health") refreshHealth();
  }));

  // ==================== CATALOG ====================
  function renderTable(){
    const head = $("#catHead");
    const body = $("#catBody");
    head.innerHTML = "";
    body.innerHTML = "";

    const cols = catalog.columns || [];
    if(!cols.length){
      head.innerHTML = "<th>Aucune colonne</th>";
      return;
    }
    cols.forEach(c => {
      const th = document.createElement("th");
      th.textContent = c;
      head.appendChild(th);
    });
    const thA = document.createElement("th");
    thA.textContent = "Actions";
    head.appendChild(thA);

    (catalog.rows||[]).forEach((row, idx) => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.value = row?.[c] ?? "";
        inp.addEventListener("input", () => { catalog.rows[idx][c] = inp.value; });
        td.appendChild(inp);
        tr.appendChild(td);
      });
      const tdA = document.createElement("td");
      tdA.className = "actionsCol";
      const del = document.createElement("button");
      del.className = "miniBtn del";
      del.textContent = "Suppr.";
      del.addEventListener("click", () => {
        catalog.rows.splice(idx, 1);
        renderTable();
      });
      tdA.appendChild(del);
      tr.appendChild(tdA);
      body.appendChild(tr);
    });

    $("#catMeta").textContent = catalog.kind
      ? ("Fichier: " + catalog.filename + " | Colonnes: " + cols.length + " | Lignes: " + (catalog.rows||[]).length)
      : "";
  }

  $("#btnLoad").addEventListener("click", async () => {
    try{
      const kind = $("#catalogKind").value;
      const out = await api("/api/admin/catalog/" + encodeURIComponent(kind));
      catalog = out;
      renderTable();
    }catch(e){
      alert("Erreur chargement: " + (e?.message || e));
    }
  });

  $("#btnAddRow").addEventListener("click", () => {
    const cols = catalog.columns || [];
    if(!cols.length){ alert("Charge un catalogue d'abord."); return; }
    const r = {};
    cols.forEach(c => r[c] = "");
    catalog.rows.push(r);
    renderTable();
  });

  $("#btnSave").addEventListener("click", async () => {
    try{
      if(!catalog.kind){ alert("Charge un catalogue d'abord."); return; }
      await api("/api/admin/catalog/" + encodeURIComponent(catalog.kind), {
        method:"PUT",
        body: JSON.stringify({columns: catalog.columns, rows: catalog.rows})
      });
      alert("Enregistre OK");
    }catch(e){
      alert("Erreur save: " + (e?.message || e));
    }
  });

  // ==================== KPI METIER ====================
  function updateMonthDisplay(){
    const months = ["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"];
    $("#currentMonth").textContent = months[currentMonth.getMonth()] + " " + currentMonth.getFullYear();
  }

  $("#btnPrevMonth").addEventListener("click", () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    updateMonthDisplay();
    refreshKpiMetier();
  });

  $("#btnNextMonth").addEventListener("click", () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    updateMonthDisplay();
    refreshKpiMetier();
  });

  async function refreshKpiMetier(){
    try {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      
      const summary = await api("/api/kpi/summary");
      const events = await api(`/api/kpi/events?limit=5000`);
      
      const monthStr = `${year}-${String(month).padStart(2,'0')}`;
      const monthEvents = (events.rows || []).filter(e => 
        (e.ts_utc || "").startsWith(monthStr)
      );
      
      const computeEvents = monthEvents.filter(e => e.event === "compute_project");
      const nbConfigs = computeEvents.length;
      $("#kpiConfigs").textContent = nbConfigs;
      
      let totalCameras = 0;
      const cameraCount = {};
      const nvrCount = {};
      const rangeCount = {};
      const siteTypeCount = {};
      const objectiveCount = {};
      const emplacementCount = {};
      const distanceList = [];
      const distanceBuckets = { "0-10m": 0, "10-25m": 0, "25-50m": 0, "50-100m": 0, "100m+": 0 };
      const codecCount = {};
      const fpsCount = {};
      const hddCount = {};
      const screenSizeCount = {};
      const sessions = new Set();
      let totalTB = 0, totalMbps = 0, totalRetentionDays = 0;
      let storageCount = 0, mbpsCount = 0, retentionCount = 0;
      let complementScreen = 0, complementEnclosure = 0, complementSignage = 0;
      
      computeEvents.forEach(e => {
        const p = e.payload || {};
        sessions.add(p.sid || e.session_id);
        
        const camQty = Number(p.cam_total_qty) || 0;
        totalCameras += camQty;
        
        const siteType = p.config_type || p.use_case || "Autre";
        siteTypeCount[siteType] = (siteTypeCount[siteType] || 0) + 1;
        
        if(p.nvr_id) nvrCount[p.nvr_id] = (nvrCount[p.nvr_id] || 0) + 1;
        
        // Stockage
        const st = p.storage || {};
        if(st.required_tb > 0) { totalTB += st.required_tb; storageCount++; }
        if(st.total_mbps > 0) { totalMbps += st.total_mbps; mbpsCount++; }
        if(st.hdd_id) hddCount[st.hdd_id + (st.hdd_count > 1 ? ` x${st.hdd_count}` : "")] = (hddCount[st.hdd_id] || 0) + 1;
        
        // Enregistrement
        const rec = p.recording || {};
        if(rec.days > 0) { totalRetentionDays += rec.days; retentionCount++; }
        if(rec.codec) {
          const c = String(rec.codec).toUpperCase();
          codecCount[c] = (codecCount[c] || 0) + 1;
        }
        if(rec.fps > 0) {
          fpsCount[rec.fps + " IPS"] = (fpsCount[rec.fps + " IPS"] || 0) + 1;
        }
        
        // ComplÃ©ments
        const comp = p.complements || {};
        if(comp.screen_enabled) { 
          complementScreen++;
          if(comp.screen_size_inch) screenSizeCount[comp.screen_size_inch + '"'] = (screenSizeCount[comp.screen_size_inch + '"'] || 0) + 1;
        }
        if(comp.enclosure_enabled) complementEnclosure++;
        if(comp.signage_enabled) complementSignage++;
        
        // CamÃ©ras avec objectifs et emplacements
        (p.cameras || []).forEach(cam => {
          const id = cam.id || "?";
          const qty = Number(cam.qty) || 1;
          cameraCount[id] = (cameraCount[id] || 0) + qty;
          
          // Gamme â€” utiliser brand_range si disponible, sinon fallback ID
          const range = cam.range || (
            id.includes("NEXT") ? "NEXT" : 
            id.includes("ADVANCE") ? "ADVANCE" : 
            id.includes("EASY") ? "EASY" : "Autre"
          );
          rangeCount[range] = (rangeCount[range] || 0) + qty;
          
          // DORI â€” extraire des camÃ©ras
          if(cam.objective) {
            const obj = String(cam.objective).toLowerCase();
            const label = obj === "identification" ? "Identification" :
                          obj === "detection" ? "Detection" :
                          obj === "dissuasion" ? "Dissuasion" :
                          obj === "observation" ? "Observation" : obj;
            objectiveCount[label] = (objectiveCount[label] || 0) + qty;
          }
          
          // Emplacements
          if(cam.emplacement) {
            const empl = String(cam.emplacement).toLowerCase();
            const label = empl.includes("ext") ? "Exterieur" : empl.includes("int") ? "Interieur" : empl;
            emplacementCount[label] = (emplacementCount[label] || 0) + qty;
          }
          
          // Distances
          if(cam.distance > 0) {
            distanceList.push(cam.distance);
            const d = cam.distance;
            if(d <= 10) distanceBuckets["0-10m"] += qty;
            else if(d <= 25) distanceBuckets["10-25m"] += qty;
            else if(d <= 50) distanceBuckets["25-50m"] += qty;
            else if(d <= 100) distanceBuckets["50-100m"] += qty;
            else distanceBuckets["100m+"] += qty;
          }
        });
      });
      
      // KPIs principaux
      $("#kpiCameras").textContent = totalCameras;
      $("#kpiAvgCam").innerHTML = nbConfigs > 0 ? (totalCameras / nbConfigs).toFixed(1) + "<small> cam/config</small>" : "--";
      $("#kpiSessions").textContent = sessions.size;
      
      // KPIs secondaires
      $("#kpiAvgStorage").innerHTML = storageCount > 0 ? (totalTB / storageCount).toFixed(1) + "<small> To</small>" : "--";
      $("#kpiAvgMbps").innerHTML = mbpsCount > 0 ? (totalMbps / mbpsCount).toFixed(0) + "<small> Mbps</small>" : "--";
      $("#kpiAvgRetention").innerHTML = retentionCount > 0 ? (totalRetentionDays / retentionCount).toFixed(0) + "<small> jours</small>" : "--";
      
      const compTotal = nbConfigs || 1;
      const screenPct = Math.round(complementScreen / compTotal * 100);
      const enclosurePct = Math.round(complementEnclosure / compTotal * 100);
      const signagePct = Math.round(complementSignage / compTotal * 100);
      $("#kpiComplementRate").innerHTML = nbConfigs > 0 ? screenPct + "<small>%</small>" : "--";
      
      // ComplÃ©ments dÃ©taillÃ©s
      const compDiv = $("#complementStats");
      if(compDiv && nbConfigs > 0) {
        compDiv.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
            <div style="display:flex;align-items:center;gap:10px">
              <span style="width:90px;font-size:12px;font-weight:800">Ecran</span>
              <div style="flex:1;background:rgba(0,0,0,.06);border-radius:6px;height:22px;overflow:hidden">
                <div style="width:${screenPct}%;height:100%;background:#00BC70;border-radius:6px;min-width:${screenPct > 0 ? '24px' : '0'}"></div>
              </div>
              <span style="font-size:13px;font-weight:900;width:40px;text-align:right">${screenPct}%</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span style="width:90px;font-size:12px;font-weight:800">Boitier</span>
              <div style="flex:1;background:rgba(0,0,0,.06);border-radius:6px;height:22px;overflow:hidden">
                <div style="width:${enclosurePct}%;height:100%;background:#3B82F6;border-radius:6px;min-width:${enclosurePct > 0 ? '24px' : '0'}"></div>
              </div>
              <span style="font-size:13px;font-weight:900;width:40px;text-align:right">${enclosurePct}%</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span style="width:90px;font-size:12px;font-weight:800">Signalisation</span>
              <div style="flex:1;background:rgba(0,0,0,.06);border-radius:6px;height:22px;overflow:hidden">
                <div style="width:${signagePct}%;height:100%;background:#F59E0B;border-radius:6px;min-width:${signagePct > 0 ? '24px' : '0'}"></div>
              </div>
              <span style="font-size:13px;font-weight:900;width:40px;text-align:right">${signagePct}%</span>
            </div>
          </div>`;
      }
      
      // Listes
      renderTopList("#topCameras", cameraCount, 10);
      renderTopList("#topNvrs", nvrCount, 5);
      renderTopList("#topRanges", rangeCount, 5);
      renderTopList("#topHdds", hddCount, 5);
      
      // Enregistrement : fusionner codec + fps
      const recData = {};
      Object.entries(codecCount).forEach(([k, v]) => recData["Codec " + k] = v);
      Object.entries(fpsCount).forEach(([k, v]) => recData[k] = v);
      renderTopList("#topRecording", recData, 8);
      
      // Distances top
      const distCount = {};
      distanceList.forEach(d => { const k = d + "m"; distCount[k] = (distCount[k] || 0) + 1; });
      renderTopList("#topDistances", distCount, 8);
      
      // Ã‰crans
      renderTopList("#topScreenSizes", screenSizeCount, 5);
      
      // Charts
      renderCharts(summary, siteTypeCount, monthEvents, objectiveCount, emplacementCount, distanceBuckets);
      
    } catch(e) {
      console.error("KPI error:", e);
    }
  }

  function renderTopList(selector, data, limit = 10){
    const ul = $(selector);
    if(!ul) return;
    
    const sorted = Object.entries(data)
      .sort((a,b) => b[1] - a[1])
      .slice(0, limit);
    
    if(sorted.length === 0){
      ul.innerHTML = "<li class='muted'>Aucune donnee</li>";
      return;
    }
    
    ul.innerHTML = sorted.map((item, idx) => {
      const [name, count] = item;
      const rankClass = idx < 3 ? "rank top3" : "rank";
      return `<li>
        <span class="${rankClass}">${idx + 1}</span>
        <span class="name">${name}</span>
        <span class="val">${count}</span>
      </li>`;
    }).join("");
  }

  function renderCharts(summary, siteTypeCount, monthEvents, objectiveCount, emplacementCount, distanceBuckets){
    const chartColors = ['#00BC70', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
    const byDay = summary.by_day || [];
    const last12Months = {};
    const now = new Date();
    for(let i = 11; i >= 0; i--){
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      last12Months[key] = 0;
    }
    byDay.forEach(d => {
      const monthKey = (d.date || "").slice(0, 7);
      if(last12Months.hasOwnProperty(monthKey)){
        last12Months[monthKey] += d.count || 0;
      }
    });
    
    const labels1 = Object.keys(last12Months);
    const data1 = Object.values(last12Months);
    
    if(chartConfigs) chartConfigs.destroy();
    chartConfigs = new Chart($("#chartConfigs"), {
      type: 'line',
      data: {
        labels: labels1.map(l => {
          const [y, m] = l.split('-');
          return ["Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aout","Sep","Oct","Nov","Dec"][parseInt(m)-1] + " " + y.slice(2);
        }),
        datasets: [{
          label: 'Evenements',
          data: data1,
          borderColor: '#00BC70',
          backgroundColor: 'rgba(0,188,112,0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
    
    // Site types doughnut
    const siteLabels = Object.keys(siteTypeCount);
    const siteData = Object.values(siteTypeCount);
    if(chartSiteTypes) chartSiteTypes.destroy();
    if(siteLabels.length > 0){
      chartSiteTypes = new Chart($("#chartSiteTypes"), {
        type: 'doughnut',
        data: {
          labels: siteLabels,
          datasets: [{ data: siteData, backgroundColor: chartColors }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }
    
    // Weekday bar
    const weekdayCount = [0,0,0,0,0,0,0];
    monthEvents.forEach(e => {
      const d = new Date(e.ts_utc);
      if(!isNaN(d)) weekdayCount[d.getDay()]++;
    });
    if(chartWeekday) chartWeekday.destroy();
    chartWeekday = new Chart($("#chartWeekday"), {
      type: 'bar',
      data: {
        labels: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
        datasets: [{
          label: 'Activite',
          data: weekdayCount,
          backgroundColor: 'rgba(0,188,112,0.6)',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
    
    // DORI doughnut
    const doriLabels = Object.keys(objectiveCount || {});
    const doriData = Object.values(objectiveCount || {});
    if(chartDori) chartDori.destroy();
    if(doriLabels.length > 0){
      chartDori = new Chart($("#chartDori"), {
        type: 'doughnut',
        data: {
          labels: doriLabels,
          datasets: [{ data: doriData, backgroundColor: ['#00BC70', '#3B82F6', '#F59E0B', '#EF4444'] }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    } else {
      const ctx = $("#chartDori");
      if(ctx) {
        const parent = ctx.parentElement;
        if(parent) parent.innerHTML = '<div class="muted" style="display:grid;place-items:center;height:100%">Aucune donnee DORI.<br><small>Les objectifs seront visibles apres la prochaine mise a jour des KPI.</small></div>';
      }
    }
    
    // Emplacements bar
    const emplLabels = Object.keys(emplacementCount || {});
    const emplData = Object.values(emplacementCount || {});
    if(chartEmplacement) chartEmplacement.destroy();
    if(emplLabels.length > 0){
      chartEmplacement = new Chart($("#chartEmplacement"), {
        type: 'bar',
        data: {
          labels: emplLabels,
          datasets: [{
            label: 'Cameras',
            data: emplData,
            backgroundColor: ['#3B82F6', '#F59E0B', '#8B5CF6'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }
    
    // Distances bar
    const distLabels = Object.keys(distanceBuckets || {});
    const distData = Object.values(distanceBuckets || {});
    if(chartDistances) chartDistances.destroy();
    if(distData.some(v => v > 0)){
      chartDistances = new Chart($("#chartDistances"), {
        type: 'bar',
        data: {
          labels: distLabels,
          datasets: [{
            label: 'Cameras',
            data: distData,
            backgroundColor: 'rgba(59,130,246,0.6)',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  }

  $("#btnRefreshKpi").addEventListener("click", () => refreshKpiMetier());

  $("#btnExportKpi").addEventListener("click", async () => {
    try{
      const res = await fetch("/api/kpi/export.csv", {headers: {"Authorization":"Bearer "+token}});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "kpi_export.csv";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2500);
    }catch(e){
      alert("Export error: " + (e?.message||e));
    }
  });

  // ==================== RESET MOIS ====================
  $("#btnResetMonth").addEventListener("click", async () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth() + 1;
    const monthNames = ["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"];
    const monthName = monthNames[month - 1] + " " + year;
    
    const confirm1 = confirm(
      "ATTENTION - SUPPRESSION DEFINITIVE\n\n" +
      "Tu vas supprimer TOUS les evenements KPI du mois de " + monthName + ".\n\n" +
      "Cette action est IRREVERSIBLE.\n\n" +
      "Continuer ?"
    );
    
    if(!confirm1) return;
    
    const confirm2 = prompt(
      "Pour confirmer, tape le mois en cours :\n" + monthName + "\n\n" +
      "(Ceci est une mesure de securite)"
    );
    
    if(confirm2 !== monthName){
      alert("Confirmation incorrecte. Suppression annulee.");
      return;
    }
    
    try {
      const btn = $("#btnResetMonth");
      btn.disabled = true;
      btn.textContent = "Suppression...";
      
      const monthStr = year + "-" + String(month).padStart(2, "0");
      
      const res = await api("/api/kpi/reset-month", {
        method: "DELETE",
        body: JSON.stringify({ month: monthStr })
      });
      
      alert("Suppression terminee !\n\n" + (res.message || res.deleted + " evenements supprimes"));
      
      refreshKpiMetier();
      
    } catch(e) {
      alert("Erreur lors de la suppression :\n" + (e?.message || e));
    } finally {
      const btn = $("#btnResetMonth");
      btn.disabled = false;
      btn.textContent = "Reset mois (tests)";
    }
  });

  // ==================== EVENTS BRUTS ====================
  $("#btnLoadEvents").addEventListener("click", async () => {
    const limit = Number($("#kpiLimit").value || 200);
    const eventType = $("#kpiEventType").value;
    
    let url = `/api/kpi/events?limit=${limit}`;
    if(eventType) url += `&event=${encodeURIComponent(eventType)}`;
    
    const out = await api(url);
    const rows = out.rows || [];
    const div = $("#kpiEvents");
    
    div.innerHTML = rows.map(r => {
      const t = (r.ts_utc||"").replace("T"," ").replace("Z","");
      const p = JSON.stringify(r.payload||{}, null, 2);
      return `<div style='padding:10px 0;border-bottom:1px solid rgba(28,31,42,.08)'>
        <div>
          <span class='pill' style="font-size:11px">${r.event||""}</span>
          <span class='muted' style="margin-left:8px">${t}</span>
          <span class='muted mono' style="margin-left:8px">sid: ${(r.session_id||"").slice(0,8)}...</span>
        </div>
        <pre class='muted mono' style='margin:8px 0 0;font-size:11px;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.02);padding:8px;border-radius:8px'>${p}</pre>
      </div>`;
    }).join("") || "<div class='muted'>Aucun event.</div>";
  });

  // ==================== SANTE BDD ====================
  async function refreshHealth(){
    // Accessories a une structure diffÃ©rente (mapping cameraâ†’accessoires), pas de check image standard
    const families = ["cameras","nvrs","hdds","switches","screens","enclosures","signage"];
    
    let totalProducts = 0;
    let totalNoImg = 0;
    let totalNoDs = 0;
    const familyStats = [];
    const missingProducts = [];
    
    for(const fam of families){
      try {
        const data = await api(`/api/admin/catalog/${fam}`);
        const rows = data.rows || [];
        const cols = data.columns || [];
        const count = rows.length;
        totalProducts += count;
        
        let noImg = 0, noName = 0, noId = 0;
        
        rows.forEach(r => {
          const id = String(r.id || "").trim();
          const name = String(r.name || "").trim();
          const img = String(r.image_url || "").trim();
          
          if(!id) noId++;
          if(!name) noName++;
          if(!img || img === "false") noImg++;
          
          const issues = [];
          if(!name) issues.push("nom manquant");
          if(!img || img === "false") issues.push("image manquante");
          if(issues.length > 0 && id) {
            missingProducts.push({ family: fam, id, issues });
          }
        });
        
        totalNoImg += noImg;
        
        familyStats.push({
          family: fam,
          count,
          cols: cols.length,
          noImg,
          noName,
          noId,
          imgPct: count > 0 ? Math.round((count - noImg) / count * 100) : 0,
        });
        
      } catch(e) {
        familyStats.push({ family: fam, count: 0, error: e.message });
      }
    }
    
    // Ajouter accessories en tant que ligne info (pas de check image)
    try {
      const accData = await api("/api/admin/catalog/accessories");
      const accRows = accData.rows || [];
      familyStats.push({
        family: "accessories",
        count: accRows.length,
        cols: (accData.columns || []).length,
        noImg: 0, noName: 0, noId: 0,
        imgPct: -1, // flag: pas de check
        isMapping: true,
      });
      totalProducts += accRows.length;
    } catch(e) {
      familyStats.push({ family: "accessories", count: 0, error: e.message });
    }
    
    // KPIs
    $("#healthTotal").textContent = totalProducts;
    $("#healthNoImg").textContent = totalNoImg;
    $("#healthNoDs").textContent = "--";
    const completePct = totalProducts > 0 ? Math.round((totalProducts - totalNoImg) / totalProducts * 100) : 0;
    $("#healthScore").innerHTML = completePct + "<small>%</small>";
    
    // Table des familles
    const detailsDiv = $("#healthDetails");
    detailsDiv.innerHTML = `
      <table style="width:100%;border-collapse:collapse;font-size:13px">
        <thead>
          <tr style="border-bottom:2px solid var(--line)">
            <th style="text-align:left;padding:8px;font-weight:900">Famille</th>
            <th style="text-align:right;padding:8px">Produits</th>
            <th style="text-align:right;padding:8px">Colonnes</th>
            <th style="text-align:right;padding:8px">Sans image</th>
            <th style="text-align:right;padding:8px">Sans nom</th>
            <th style="text-align:left;padding:8px">Couverture image</th>
          </tr>
        </thead>
        <tbody>
          ${familyStats.map(f => {
            if(f.error) return `<tr><td style="padding:8px">${f.family}</td><td colspan="5" class="muted">${f.error}</td></tr>`;
            if(f.isMapping) return `<tr style="border-bottom:1px solid var(--line)">
              <td style="padding:8px;font-weight:800">${f.family} <span class="muted" style="font-size:10px">(mapping)</span></td>
              <td style="padding:8px;text-align:right;font-weight:900">${f.count}</td>
              <td style="padding:8px;text-align:right">${f.cols}</td>
              <td colspan="3" style="padding:8px;color:var(--muted);font-size:12px">Structure mapping â€” pas de check image</td>
            </tr>`;
            const barColor = f.imgPct >= 90 ? '#00BC70' : f.imgPct >= 60 ? '#F59E0B' : '#DC2626';
            return `<tr style="border-bottom:1px solid var(--line)">
              <td style="padding:8px;font-weight:800">${f.family}</td>
              <td style="padding:8px;text-align:right;font-weight:900">${f.count}</td>
              <td style="padding:8px;text-align:right">${f.cols}</td>
              <td style="padding:8px;text-align:right;color:${f.noImg > 0 ? '#DC2626' : 'inherit'};font-weight:${f.noImg > 0 ? '900' : 'normal'}">${f.noImg}</td>
              <td style="padding:8px;text-align:right;color:${f.noName > 0 ? '#F59E0B' : 'inherit'}">${f.noName}</td>
              <td style="padding:8px;width:180px">
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="flex:1;background:rgba(0,0,0,.06);border-radius:4px;height:16px;overflow:hidden">
                    <div style="width:${f.imgPct}%;height:100%;background:${barColor};border-radius:4px"></div>
                  </div>
                  <span style="font-weight:900;font-size:12px;width:32px;text-align:right">${f.imgPct}%</span>
                </div>
              </td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
    
    // Produits incomplets
    const missingDiv = $("#healthMissing");
    if(missingProducts.length === 0){
      missingDiv.innerHTML = '<div style="color:#00BC70;font-weight:800">âœ… Tous les produits sont complets !</div>';
    } else {
      const shown = missingProducts.slice(0, 50);
      missingDiv.innerHTML = `
        <div style="margin-bottom:8px;font-size:12px;color:var(--muted)">${missingProducts.length} produits avec donnees manquantes${missingProducts.length > 50 ? ` (50 premiers affiches)` : ''}</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:6px">
          ${shown.map(p => `
            <div style="padding:8px 12px;border-radius:8px;border:1px solid var(--line);font-size:12px;display:flex;justify-content:space-between;align-items:center">
              <div>
                <span style="font-weight:900">${p.id}</span>
                <span class="muted" style="margin-left:4px">${p.family}</span>
              </div>
              <div style="display:flex;gap:4px">
                ${p.issues.map(i => `<span style="padding:2px 6px;border-radius:4px;font-size:10px;font-weight:800;background:${i.includes('image') ? 'rgba(220,38,38,.1);color:#DC2626' : 'rgba(245,158,11,.1);color:#92400e'}">${i}</span>`).join("")}
              </div>
            </div>
          `).join("")}
        </div>`;
    }
  }
  
  const btnHealth = $("#btnRefreshHealth");
  if(btnHealth) btnHealth.addEventListener("click", refreshHealth);

  // ==================== INIT ====================
  checkAuth();
})();
</script>
</body>
</html>